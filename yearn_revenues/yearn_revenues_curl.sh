#!/bin/bash

set -x;

#*********************
# pulls YFI revenues directly from their website
# Check the availability of the data before!
# https://www.yfistats.com/financials/RevProjections.html
#*********************

curl 'https://wabi-us-west2-api.analysis.windows.net/public/reports/querydata?synchronous=true' -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:96.0) Gecko/20100101 Firefox/96.0' -H 'Accept: application/json, text/plain, */*' -H 'Accept-Language: en-GB,en;q=0.5' -H 'Accept-Encoding: gzip, deflate, br' -H 'ActivityId: 2e2e09db-1fd1-4ab7-b71c-88938055fc04' -H 'RequestId: 4945f9aa-365f-3a8b-af35-c1045bdd3b69' -H 'X-PowerBI-ResourceKey: 4b35a708-e5aa-4953-a5f9-939a12dabe9f' -H 'Content-Type: application/json;charset=UTF-8' -H 'Origin: https://app.powerbi.com' -H 'Connection: keep-alive' -H 'Referer: https://app.powerbi.com/' -H 'Sec-Fetch-Dest: empty' -H 'Sec-Fetch-Mode: cors' -H 'Sec-Fetch-Site: cross-site' --data-raw '{"version":"1.0.0","queries":[{"Query":{"Commands":[{"SemanticQueryDataShapeCommand":{"Query":{"Version":2,"From":[{"Name":"y","Entity":"YearnGeneralLedger","Type":0},{"Name":"l","Entity":"LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911","Type":0}],"Select":[{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Year"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Year"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Quarter"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Quarter"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Month"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Month"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Day"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Day"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"YearnGeneralLedger.Rolling 30d SumRevenue"},"Name":"YearnGeneralLedger.Rolling 30d SumRevenue"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"forecastValue"},"Name":"forecastValue"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"confidenceHighBound"},"Name":"confidenceHighBound"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"confidenceLowBound"},"Name":"confidenceLowBound"},{"Column":{"Expression":{"TransformTableRef":{"Source":"output0"}},"Property":"Min(LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911.Date)"},"Name":"Min(LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911.Date)"}],"Transform":[{"Name":"Forecast","Algorithm":"Forecast","Input":{"Parameters":[{"Literal":{"Value":"3D"},"Name":"Unit"},{"Literal":{"Value":"365D"},"Name":"ForecastLength"},{"Literal":{"Value":"30D"},"Name":"IgnoreLast"},{"Literal":{"Value":"0.99D"},"Name":"ConfidenceLevel"}],"Table":{"Name":"input0","Columns":[{"Expression":{"HierarchyLevel":{"Expression":{"Hierarchy":{"Expression":{"PropertyVariationSource":{"Expression":{"SourceRef":{"Source":"y"}},"Name":"Variation","Property":"timestamp"}},"Hierarchy":"Date Hierarchy"}},"Level":"Year"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Year"}},{"Expression":{"HierarchyLevel":{"Expression":{"Hierarchy":{"Expression":{"PropertyVariationSource":{"Expression":{"SourceRef":{"Source":"y"}},"Name":"Variation","Property":"timestamp"}},"Hierarchy":"Date Hierarchy"}},"Level":"Quarter"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Quarter"}},{"Expression":{"HierarchyLevel":{"Expression":{"Hierarchy":{"Expression":{"PropertyVariationSource":{"Expression":{"SourceRef":{"Source":"y"}},"Name":"Variation","Property":"timestamp"}},"Hierarchy":"Date Hierarchy"}},"Level":"Month"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Month"}},{"Expression":{"HierarchyLevel":{"Expression":{"Hierarchy":{"Expression":{"PropertyVariationSource":{"Expression":{"SourceRef":{"Source":"y"}},"Name":"Variation","Property":"timestamp"}},"Hierarchy":"Date Hierarchy"}},"Level":"Day"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Day"}},{"Expression":{"Measure":{"Expression":{"SourceRef":{"Source":"y"}},"Property":"Rolling 30d SumRevenue"},"Name":"YearnGeneralLedger.Rolling 30d SumRevenue"},"Role":"Y"},{"Expression":{"Aggregation":{"Expression":{"Column":{"Expression":{"SourceRef":{"Source":"l"}},"Property":"Date"}},"Function":3},"Name":"Min(LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911.Date)"},"Role":"X"}]}},"Output":{"Table":{"Name":"output0","Columns":[{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Year"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Year"}},{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Quarter"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Quarter"}},{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Month"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Month"}},{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Day"},"Name":"YearnGeneralLedger.timestamp.Variation.Date Hierarchy.Day"}},{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"YearnGeneralLedger.Rolling 30d SumRevenue"},"Name":"YearnGeneralLedger.Rolling 30d SumRevenue"}},{"Expression":{"TransformOutputRoleRef":{"Role":"Forecast"},"Name":"forecastValue"},"Role":"forecast.ForecastValue"},{"Expression":{"TransformOutputRoleRef":{"Role":"UpperBound"},"Name":"confidenceHighBound"},"Role":"forecast.ConfidenceHighBound"},{"Expression":{"TransformOutputRoleRef":{"Role":"LowerBound"},"Name":"confidenceLowBound"},"Role":"forecast.ConfidenceLowBound"},{"Expression":{"Column":{"Expression":{"TransformTableRef":{"Source":"input0"}},"Property":"Min(LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911.Date)"},"Name":"Min(LocalDateTable_b775d174-c477-4b5d-b0f4-4b48651f1911.Date)"}}]}}}]},"Binding":{"Primary":{"Groupings":[{"Projections":[0,1,2,3,4,5,6,7,8]}]},"DataReduction":{"DataVolume":4,"Primary":{"BinnedLineSample":{"PrimaryScalarKey":8}}},"SuppressedJoinPredicates":[8],"Version":1}}}]},"QueryId":""}],"cancelQueries":[],"modelId":1711693}' --output yearn_revenues/yearn_revenues_data.gz;
gunzip yearn_revenues/yearn_revenues_data.gz;
